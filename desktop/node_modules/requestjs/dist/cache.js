var cache,clean,fs,get,hash,hashCode,path,put;fs=require("fs"),path=require("path"),clean=function(e){for(e=e.replace(/[\.:\-\?\!%@\/\s]/g,"_");!/^[A-Za-z0-9]/.test(e);)e=e.slice(1);for(;!/[A-Za-z0-9]$/.test(e);)e=e.slice(0,+(e.length-2)+1||9e9);return e},hashCode=function(e){var t,n,r,c;if(0===e.length)return 0;for(t=0,n=r=0,c=e.length-1;c>=0?c>=r:r>=c;n=c>=0?++r:--r)t=(t<<5)-t+e.charCodeAt(n),t=0|t;return t},hash=function(e){var t,n,r,c,s,o,i,a;if(r=e.method,i=e.url,t=e.json,r=r.toLowerCase(),s=r&&"get"!==r?e.body:e.qs,s&&"object"!=typeof s)throw"Unknown params";for(o=i,/^https/.test(o)&&(o=o.slice(5)),/^http/.test(o)&&(o=o.slice(4));!/^[A-Za-z0-9]/.test(o);)o=o.slice(1);if(/^www\./.test(o)&&(o=o.slice(4)),s){c="";for(n in s)a=s[n],n&&a&&(n=clean(n).slice(0,30),a=clean(String(a)).slice(0,30),c&&(c+="__"),c+=n+"_"+a);o+="."+c}return o="entry-"+hashCode(o)+"-"+r,t&&(o+="-json"),path.join(cache.dir,o)},get=function(e,t){return fs.readFile(e,"utf-8",function(e,n){return e?t(e):t(null,JSON.parse(n))})},put=function(e,t,n){return console.log("put: "+e),fs.writeFile(e,JSON.stringify(t),"utf-8",n)},cache={dir:null,get:function(e,t){var n;return cache.dir?(n=hash(e),fs.exists(n,function(e){return e?(console.log("DEBUG: cache hit: "+n),get(n,function(e,n){return t(e?null:n)})):t(null)})):t(null)},put:function(e,t,n){var r;return cache.dir?(r=hash(e),put(r,t,n)):n("No directory")}},module.exports=cache;