var ENABLE_DEBUG,METHODS,cache,request,urllib,indexOf=[].indexOf||function(e){for(var t=0,r=this.length;r>t;t++)if(t in this&&this[t]===e)return t;return-1};urllib=require("url"),request=require("request"),cache=require("./cache"),ENABLE_DEBUG=!1,METHODS={get:"GET",put:"PUT",patch:"PATCH",post:"POST",head:"HEAD",del:"DELETE"},module.exports=function(e){var t,r,l,n,c,i,u,s,o,a;if(null==e&&(e={}),l=!1,n=!1,t=null,r=null,o=null,s=request,e.requestObj&&(s=e.requestObj,delete e.requestObj),e.disableCache)n=!0,delete e.disableCache;else{if(!e.cacheDir)throw"No cache directory provided";cache.dir=e.cacheDir,delete e.cacheDir}(ENABLE_DEBUG||e.debug)&&(l=!0,delete e.debug),e.cacheBlacklist&&(t=e.cacheBlacklist,delete e.cacheBlacklist),e.cacheWhitelist&&(r=e.cacheWhitelist,delete e.cacheWhitelist),e.transformRequest&&(o=e.transformRequest,delete e.transformRequest),e.method||(e.method="GET"),u=function(){var t,r,l,n,c,i,u,s;for(s=null,i=null,r=null,u=Array.prototype.slice.call(arguments),l=n=0,c=u.length;c>n;l=++n){switch(t=u[l],typeof t){case"string":if(s)throw"Unexpected string";s=t;break;case"object":if(t.push&&t.shift)throw"Unexpected list";t.url&&(s=t.url),i=Object.assign({},t,e);break;case"function":if(r)throw"Unexpected function";r=t}if(s&&i&&r)break}if(!s)throw"Invalid request";return i=Object.assign(i||{},e),i.url=s,o&&(i=o(i)||i),[i,r]},a=function(){var e,c,i;return i=u.apply(null,arguments),c=i[0],e=i[1],n||!e?(l&&console.log("DEBUG: Disabled cache, sending request: "+JSON.stringify(c,null,2)),request(c,e)):r&&!(indexOf.call(r,url)>=0)||t&&!(indexOf.call(t,url)<0)?(l&&console.log("DEBUG: Skipping cache for the next request due to whitelist/blacklist.."),request(c,e)):void cache.get(c,function(t){return t?(l&&console.log("DEBUG: Found in request cache: "+JSON.stringify(c,null,2)),void e(null,t,t.body)):(console.log("DEBUG: Not in request cache!"),e=function(e){return function(t,r,l){var n;return n=Array.prototype.slice.call(arguments),t?e.apply(null,n):(r.cacheTime=Date.now(),cache.put(c,r,function(t){return e.apply(null,n)}))}}(e),l&&console.log("DEBUG: Not found, sending request: "+JSON.stringify(c,null,2)),request(c,e))})};for(c in METHODS)i=METHODS[c],a[c]=function(e){return function(){var t,r,l;return l=u.apply(null,arguments),r=l[0],t=l[1],r.method=e,a(r,t)}}(i);return a};